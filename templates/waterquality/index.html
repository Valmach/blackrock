{% extends 'base.html' %}
{% block js %}
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript"></script>
<script src="/site_media/js/highcharts.js" type="text/javascript"></script>
<script src="/site_media/js/modules/exporting.js" type="text/javascript"></script>
{% if show_graph %}
<script type="text/javascript">
var chart;
$(document).ready(function() {
   chart = new Highcharts.Chart({
      chart: {
         renderTo: 'chart-container',
{% ifequal type "time-series" %}
         zoomType: 'x',
{% endifequal %}
{% ifequal type "scatter-plot" %}
         defaultSeriesType: 'scatter',
         zoomType: 'xy',
{% endifequal %}
         spacingRight: 20
      },
       title: {
         text: '{{graph_title}}'
      },
{% ifequal type "time-series" %}
      xAxis: {
         type: 'datetime',
         title: {
            text: null
         }
      },
{% endifequal %}
{% ifequal type "scatter-plot" %}
      xAxis: {
         title: {
            enabled: true,
            text: '{{independent.name}}'
         },
         startOnTick: true,
         endOnTick: true,
         showLastLabel: true
      },
      yAxis: {
         title: {
            text: '{{dependent.name}}'
         }
      },

{% endifequal %}
      tooltip: {
         shared: true               
      },
      legend: {
         enabled: true
      },
      plotOptions: {
         area: {
            fillColor: {
               linearGradient: [0, 0, 0, 300],
               stops: [
                  [0, 'rgba(100,0,6,0)'],
                  [1, 'rgba(2,0,100,0)']
               ]
            },
            lineWidth: 1,
            marker: {
               enabled: false,
               states: {
                  hover: {
                     enabled: true,
                     radius: 5
                  }
               }
            },
            shadow: false,
            states: {
               hover: {
                  lineWidth: 1                  
               }
            }
         },
         scatter: {
            marker: {
               radius: 5,
               states: {
                  hover: {
                     enabled: true,
                     lineColor: 'rgb(100,100,100)'
                  }
               }
            },
            states: {
               hover: {
                  marker: {
                     enabled: false
                  }
               }
            }
         }

      },
{% ifequal type "time-series" %}
      series: [
{% for set in datasets %}
       {
         type: 'area',
         name: '{{set.series.name}}',
         pointInterval: 3600 * 1000,
         pointStart: Date.UTC({{start.year}}, {{start.month}}, {{start.day}}),
         data: [
           {% for point in set.data %}{{point}}{% if not forloop.last %},{% endif %}{% endfor %}
         ]
      }{% if not forloop.last %},{% endif %}{% if forloop.last %}{% if lines %},{% endif %}{% endif %}
{% endfor %}

 {% for line in lines %} 
   {
         name: '{{line.label}}',
         type: 'line',
         data: [[Date.UTC({{start.year}}, {{start.month}}, {{start.day}}), {{line.value}}], [Date.UTC({{end.year}}, {{end.month}}, {{end.day}}), {{line.value}}]],
         marker: {
            enabled: false
         },
         states: {
            hover: {
               lineWidth: 0
            }
         },
         enableMouseTracking: false
      }{% if not forloop.last %},{% endif %}

{% endfor %} 
      ],
{% endifequal %}

{% ifequal type "scatter-plot" %}
      series: [{
         name: '{{dependent.name}} vs {{independent.name}}',
         color: 'rgba(223, 83, 83, .5)',
         data: [{% for point in data %}[{{point.0}},{{point.1}}]{% if not forloop.last %},{% endif %}
{% endfor %}
   ]
   
      },

   {
         type: 'line',
         name: 'Regression Line',
{% with lseriesp.regression_line_points as lrp %}
         data: [[{{lrp.0.0}}, {{lrp.0.1}}], [{{lrp.1.0}}, {{lrp.1.1}}]],
{% endwith %}
         marker: {
            enabled: false
         },
         states: {
            hover: {
               lineWidth: 0
            }
         },
         enableMouseTracking: false
      }
 ],

{% endifequal %}
      exporting: {
         enabled: true
      },

   });
   
   
});
   

</script>
{% endif %}
{% endblock %}

{% block content %}

{% if show_graph %}
<div id="chart-container"></div>
{% endif %}

{% if show_box_plot %}

{% with lsg.box_data as box_data %}

  <img src="https://chart.googleapis.com/chart?chs=400x200&cht=lc&chd=t0:0,{% for bd in box_data.series %}{{bd.min}},{% endfor %}0|0,{% for bd in box_data.series %}{{bd.lq}},{% endfor %}0|0,{% for bd in box_data.series %}{{bd.uq}},{% endfor %}0|0,{% for bd in box_data.series %}{{bd.max}},{% endfor %}0|0,{% for bd in box_data.series %}{{bd.median}},{% endfor %}0&chm=F,0000FF,0,1:{{box_data.count}},20|H,0000FF,0,1:{{box_data.count}},1:20|H,0000FF,3,1:{{box_data.count}},1:20|H,0000FF,4,1:{{box_data.count}},1:20&chxt=y&chxr=0,{{box_data.min}},{{box_data.max}},0" width="400" height="200" />

{% endwith %}

{% endif %}

<form action="." method="get">
{% if type %}
<input type="hidden" name="type" value="{{type}}" />
<table>
<tr>
<td>
{% ifequal type "time-series" %}
<p><b>Series:</b>
<select name="series" multiple="multiple">
{% for series in all_series %}
<option value="{{series.id}}" {% if series.selected %}selected="selected"{% endif %}>{{series.location.site.name}}/{{series.location.name}}/{{series.name}}</option>
{% endfor %}
</select>
{% endifequal %}

{% ifequal type "box-plot" %}
<p><b>Series:</b>
<select name="series" multiple="multiple">
{% for series in all_series %}
<option value="{{series.id}}" {% if series.selected %}selected="selected"{% endif %}>{{series.location.site.name}}/{{series.location.name}}/{{series.name}}</option>
{% endfor %}
</select>
{% endifequal %}

{% ifequal type "scatter-plot" %}
<p><b>Independent:</b>
<select name="independent">
{% for series in all_series %}
<option value="{{series.id}}" {% if series.independent %}selected="selected"{% endif %}>{{series.location.site.name}}/{{series.location.name}}/{{series.name}}</option>
{% endfor %}
</select>

<p><b>Dependent:</b>
<select name="dependent">
{% for series in all_series %}
<option value="{{series.id}}" {% if series.dependent %}selected="selected"{% endif %}>{{series.location.site.name}}/{{series.location.name}}{{series.name}}</option>
{% endfor %}
</select>
{% endifequal %}

</td>

<td>

<p><b>Start:</b><br />
<input type="text" name="start" size="10" value="{{start|date:"Y-m-d"}}" /></p>

<p><b>End:</b><br />
<input type="text" name="end" size="10" value="{{end|date:"Y-m-d"}}" /></p>
</td>
<td>
Title: <input type="text" name="title" value="{{graph_title}}"/><br />

</td>

<td>
<h4>Lines</h4>
{% for line in lines %}
Label: <input type="text" name="line_label_{{line.n}}"
	      value="{{line.label}}" />
Value: <input type="text" name="line_value_{{line.n}}"
	      value="{{line.value}}" /><br />
{% endfor %}
{% with lines|length as n %}
Label: <input type="text" name="line_label_{{n}}"
	      value="" />
Value: <input type="text" name="line_value_{{n}}"
	      value="" /><br />
{% endwith %}
</td>

</tr>
</table>

<input type="submit" value="graph"/>

{% if lseriesp %}
<p>R<sup>2</sup>: {{lseriesp.linear_regression.rr|floatformat}}</p>
{% endif %}

{% else %}
<h1>Make a graph</h1>
<p><b>Title</b><br />
<input type="text" name="title" value="{{graph_title}}"/></p>

<table>
<tr>
  <td><input type="submit" name="type" value="time-series" /></td>
  <td><input type="submit" name="type" value="scatter-plot" /></td>
  <td><input type="submit" name="type" value="box-plot" /></td>
</tr>
</table>



{% endif %}

</form>


<p><a href="{% url waterquality-browse %}">browse data</a></p>

{% endblock %}
